"use strict";function hexVal(t,s,e){return parseInt(t.substr(s,e||1),16)}function map(t,s,e,a,r){var i=parseFloat(t),o=e-s,l=r-a;return(i-s)*l/o+a}function fillColor(t){return t%2===0?FILL_COLOR_LIGHT:FILL_COLOR_DARK}function fillOpacity(t){return map(t,0,15,OPACITY_MIN,OPACITY_MAX)}function buildHexagonShape(t){var s=t,e=s/2,a=Math.sin(60*Math.PI/180)*s;return[0,a,e,0,e+s,0,2*s,a,e+s,2*a,e,2*a,0,a].join(",")}function buildChevronShape(t,s){var e=.66*s;return[[0,0,t/2,s-e,t/2,s,0,e,0,0],[t/2,s-e,t,0,t,e,t/2,s,t/2,s-e]].map(function(t){return t.join(",")})}function buildPlusShape(t){return[[t,0,t,3*t],[0,t,3*t,t]]}function buildOctogonShape(t){var s=t,e=.33*s;return[e,0,s-e,0,s,e,s,s-e,s-e,s,e,s,0,s-e,0,e,e,0].join(",")}function buildTriangleShape(t,s){var e=t/2;return[e,0,t,s,0,s,e,0].join(",")}function buildDiamondShape(t,s){return[t/2,0,t,s/2,t/2,s,0,s/2].join(",")}function buildRightTriangleShape(t){return[0,0,t,t,0,t,0,0].join(",")}function drawInnerMosaicTile(t,s,e,a,r){var i=buildRightTriangleShape(a),o=fillOpacity(r[0]),l=fillColor(r[0]),h={stroke:STROKE_COLOR,"stroke-opacity":STROKE_OPACITY,"fill-opacity":o,fill:l};t.polyline(i,h).transform({translate:[s+a,e],scale:[-1,1]}),t.polyline(i,h).transform({translate:[s+a,e+2*a],scale:[1,-1]}),o=fillOpacity(r[1]),l=fillColor(r[1]),h={stroke:STROKE_COLOR,"stroke-opacity":STROKE_OPACITY,"fill-opacity":o,fill:l},t.polyline(i,h).transform({translate:[s+a,e+2*a],scale:[-1,-1]}),t.polyline(i,h).transform({translate:[s+a,e],scale:[1,1]})}function drawOuterMosaicTile(t,s,e,a,r){var i=fillOpacity(r),o=fillColor(r),l=buildRightTriangleShape(a),h={stroke:STROKE_COLOR,"stroke-opacity":STROKE_OPACITY,"fill-opacity":i,fill:o};t.polyline(l,h).transform({translate:[s,e+a],scale:[1,-1]}),t.polyline(l,h).transform({translate:[s+2*a,e+a],scale:[-1,-1]}),t.polyline(l,h).transform({translate:[s,e+a],scale:[1,1]}),t.polyline(l,h).transform({translate:[s+2*a,e+a],scale:[-1,1]})}function buildRotatedTriangleShape(t,s){var e=t/2;return[0,0,s,e,0,t,0,0].join(",")}var extend=require("extend"),color=require("./color"),SHA1=require("./sha1"),SVG=require("./svg"),DEFAULTS={baseColor:"#933c3c"},PATTERNS=["octogons","overlappingCircles","plusSigns","xes","sineWaves","hexagons","overlappingRings","plaid","triangles","squares","concentricCircles","diamonds","tessellation","nestedSquares","mosaicSquares","chevrons"],FILL_COLOR_DARK="#222",FILL_COLOR_LIGHT="#ddd",STROKE_COLOR="#000",STROKE_OPACITY=.02,OPACITY_MIN=.02,OPACITY_MAX=.15,Pattern=module.exports=function(t,s){return this.opts=extend({},DEFAULTS,s),this.hash=s.hash||SHA1(t),this.svg=new SVG,this.generateBackground(),this.generatePattern(),this};Pattern.prototype.toSvg=function(){return this.svg.toString()},Pattern.prototype.toString=function(){return this.toSvg()},Pattern.prototype.toBase64=function(){var t,s=this.toSvg();return t="undefined"!=typeof window&&"function"==typeof window.btoa?window.btoa(s):new Buffer(s).toString("base64")},Pattern.prototype.toDataUri=function(){return"data:image/svg+xml;base64,"+this.toBase64()},Pattern.prototype.toDataUrl=function(){return'url("'+this.toDataUri()+'")'},Pattern.prototype.generateBackground=function(){var t,s,e,a;this.opts.color?e=color.hex2rgb(this.opts.color):(s=map(hexVal(this.hash,14,3),0,4095,0,359),a=hexVal(this.hash,17),t=color.rgb2hsl(color.hex2rgb(this.opts.baseColor)),t.h=(360*t.h-s+360)%360/360,a%2===0?t.s=Math.min(1,(100*t.s+a)/100):t.s=Math.max(0,(100*t.s-a)/100),e=color.hsl2rgb(t)),this.color=color.rgb2hex(e),this.svg.rect(0,0,"100%","100%",{fill:color.rgb2rgbString(e)})},Pattern.prototype.generatePattern=function(){var t=this.opts.generator;if(t){if(PATTERNS.indexOf(t)<0)throw new Error("The generator "+t+" does not exist.")}else t=PATTERNS[hexVal(this.hash,20)];return this["geo"+t.slice(0,1).toUpperCase()+t.slice(1)]()},Pattern.prototype.geoHexagons=function(){var t,s,e,a,r,i,o,l,h=hexVal(this.hash,0),n=map(h,0,15,8,60),c=n*Math.sqrt(3),p=2*n,f=buildHexagonShape(n);for(this.svg.setWidth(3*p+3*n),this.svg.setHeight(6*c),e=0,l=0;6>l;l++)for(o=0;6>o;o++)i=hexVal(this.hash,e),t=o%2===0?l*c:l*c+c/2,a=fillOpacity(i),s=fillColor(i),r={fill:s,"fill-opacity":a,stroke:STROKE_COLOR,"stroke-opacity":STROKE_OPACITY},this.svg.polyline(f,r).transform({translate:[o*n*1.5-p/2,t-c/2]}),0===o&&this.svg.polyline(f,r).transform({translate:[6*n*1.5-p/2,t-c/2]}),0===l&&(t=o%2===0?6*c:6*c+c/2,this.svg.polyline(f,r).transform({translate:[o*n*1.5-p/2,t-c/2]})),0===o&&0===l&&this.svg.polyline(f,r).transform({translate:[6*n*1.5-p/2,5*c+c/2]}),e++},Pattern.prototype.geoSineWaves=function(){var t,s,e,a,r,i,o,l=Math.floor(map(hexVal(this.hash,0),0,15,100,400)),h=Math.floor(map(hexVal(this.hash,1),0,15,30,100)),n=Math.floor(map(hexVal(this.hash,2),0,15,3,30));for(this.svg.setWidth(l),this.svg.setHeight(36*n),s=0;36>s;s++)i=hexVal(this.hash,s),e=fillOpacity(i),t=fillColor(i),o=l/4*.7,r={fill:"none",stroke:t,opacity:e,"stroke-width":""+n+"px"},a="M0 "+h+" C "+o+" 0, "+(l/2-o)+" 0, "+l/2+" "+h+" S "+(l-o)+" "+2*h+", "+l+" "+h+" S "+(1.5*l-o)+" 0, "+1.5*l+", "+h,this.svg.path(a,r).transform({translate:[-l/4,n*s-1.5*h]}),this.svg.path(a,r).transform({translate:[-l/4,n*s-1.5*h+36*n]})},Pattern.prototype.geoChevrons=function(){var t,s,e,a,r,i,o,l=map(hexVal(this.hash,0),0,15,30,80),h=map(hexVal(this.hash,0),0,15,30,80),n=buildChevronShape(l,h);for(this.svg.setWidth(6*l),this.svg.setHeight(6*h*.66),s=0,o=0;6>o;o++)for(i=0;6>i;i++)r=hexVal(this.hash,s),e=fillOpacity(r),t=fillColor(r),a={stroke:STROKE_COLOR,"stroke-opacity":STROKE_OPACITY,fill:t,"fill-opacity":e,"stroke-width":1},this.svg.group(a).transform({translate:[i*l,o*h*.66-h/2]}).polyline(n).end(),0===o&&this.svg.group(a).transform({translate:[i*l,6*h*.66-h/2]}).polyline(n).end(),s+=1},Pattern.prototype.geoPlusSigns=function(){var t,s,e,a,r,i,o,l,h=map(hexVal(this.hash,0),0,15,10,25),n=3*h,c=buildPlusShape(h);for(this.svg.setWidth(12*h),this.svg.setHeight(12*h),e=0,l=0;6>l;l++)for(o=0;6>o;o++)i=hexVal(this.hash,e),a=fillOpacity(i),s=fillColor(i),t=l%2===0?0:1,r={fill:s,stroke:STROKE_COLOR,"stroke-opacity":STROKE_OPACITY,"fill-opacity":a},this.svg.group(r).transform({translate:[o*n-o*h+t*h-h,l*n-l*h-n/2]}).rect(c).end(),0===o&&this.svg.group(r).transform({translate:[4*n-o*h+t*h-h,l*n-l*h-n/2]}).rect(c).end(),0===l&&this.svg.group(r).transform({translate:[o*n-o*h+t*h-h,4*n-l*h-n/2]}).rect(c).end(),0===o&&0===l&&this.svg.group(r).transform({translate:[4*n-o*h+t*h-h,4*n-l*h-n/2]}).rect(c).end(),e++},Pattern.prototype.geoXes=function(){var t,s,e,a,r,i,o,l,h=map(hexVal(this.hash,0),0,15,10,25),n=buildPlusShape(h),c=3*h*.943;for(this.svg.setWidth(3*c),this.svg.setHeight(3*c),e=0,l=0;6>l;l++)for(o=0;6>o;o++)i=hexVal(this.hash,e),a=fillOpacity(i),t=o%2===0?l*c-.5*c:l*c-.5*c+c/4,s=fillColor(i),r={fill:s,opacity:a},this.svg.group(r).transform({translate:[o*c/2-c/2,t-l*c/2],rotate:[45,c/2,c/2]}).rect(n).end(),0===o&&this.svg.group(r).transform({translate:[6*c/2-c/2,t-l*c/2],rotate:[45,c/2,c/2]}).rect(n).end(),0===l&&(t=o%2===0?6*c-c/2:6*c-c/2+c/4,this.svg.group(r).transform({translate:[o*c/2-c/2,t-6*c/2],rotate:[45,c/2,c/2]}).rect(n).end()),5===l&&this.svg.group(r).transform({translate:[o*c/2-c/2,t-11*c/2],rotate:[45,c/2,c/2]}).rect(n).end(),0===o&&0===l&&this.svg.group(r).transform({translate:[6*c/2-c/2,t-6*c/2],rotate:[45,c/2,c/2]}).rect(n).end(),e++},Pattern.prototype.geoOverlappingCircles=function(){var t,s,e,a,r,i,o,l=hexVal(this.hash,0),h=map(l,0,15,25,200),n=h/2;for(this.svg.setWidth(6*n),this.svg.setHeight(6*n),s=0,o=0;6>o;o++)for(i=0;6>i;i++)r=hexVal(this.hash,s),e=fillOpacity(r),t=fillColor(r),a={fill:t,opacity:e},this.svg.circle(i*n,o*n,n,a),0===i&&this.svg.circle(6*n,o*n,n,a),0===o&&this.svg.circle(i*n,6*n,n,a),0===i&&0===o&&this.svg.circle(6*n,6*n,n,a),s++},Pattern.prototype.geoOctogons=function(){var t,s,e,a,r,i,o=map(hexVal(this.hash,0),0,15,10,60),l=buildOctogonShape(o);for(this.svg.setWidth(6*o),this.svg.setHeight(6*o),s=0,i=0;6>i;i++)for(r=0;6>r;r++)a=hexVal(this.hash,s),e=fillOpacity(a),t=fillColor(a),this.svg.polyline(l,{fill:t,"fill-opacity":e,stroke:STROKE_COLOR,"stroke-opacity":STROKE_OPACITY}).transform({translate:[r*o,i*o]}),s+=1},Pattern.prototype.geoSquares=function(){var t,s,e,a,r,i,o=map(hexVal(this.hash,0),0,15,10,60);for(this.svg.setWidth(6*o),this.svg.setHeight(6*o),s=0,i=0;6>i;i++)for(r=0;6>r;r++)a=hexVal(this.hash,s),e=fillOpacity(a),t=fillColor(a),this.svg.rect(r*o,i*o,o,o,{fill:t,"fill-opacity":e,stroke:STROKE_COLOR,"stroke-opacity":STROKE_OPACITY}),s+=1},Pattern.prototype.geoConcentricCircles=function(){var t,s,e,a,r,i,o=hexVal(this.hash,0),l=map(o,0,15,10,60),h=l/5;for(this.svg.setWidth(6*(l+h)),this.svg.setHeight(6*(l+h)),s=0,i=0;6>i;i++)for(r=0;6>r;r++)a=hexVal(this.hash,s),e=fillOpacity(a),t=fillColor(a),this.svg.circle(r*l+r*h+(l+h)/2,i*l+i*h+(l+h)/2,l/2,{fill:"none",stroke:t,opacity:e,"stroke-width":h+"px"}),a=hexVal(this.hash,39-s),e=fillOpacity(a),t=fillColor(a),this.svg.circle(r*l+r*h+(l+h)/2,i*l+i*h+(l+h)/2,l/4,{fill:t,"fill-opacity":e}),s+=1},Pattern.prototype.geoOverlappingRings=function(){var t,s,e,a,r,i,o,l=hexVal(this.hash,0),h=map(l,0,15,10,60),n=h/4;for(this.svg.setWidth(6*h),this.svg.setHeight(6*h),s=0,o=0;6>o;o++)for(i=0;6>i;i++)r=hexVal(this.hash,s),e=fillOpacity(r),t=fillColor(r),a={fill:"none",stroke:t,opacity:e,"stroke-width":n+"px"},this.svg.circle(i*h,o*h,h-n/2,a),0===i&&this.svg.circle(6*h,o*h,h-n/2,a),0===o&&this.svg.circle(i*h,6*h,h-n/2,a),0===i&&0===o&&this.svg.circle(6*h,6*h,h-n/2,a),s+=1},Pattern.prototype.geoTriangles=function(){var t,s,e,a,r,i,o,l,h=hexVal(this.hash,0),n=map(h,0,15,15,80),c=n/2*Math.sqrt(3),p=buildTriangleShape(n,c);for(this.svg.setWidth(3*n),this.svg.setHeight(6*c),s=0,l=0;6>l;l++)for(o=0;6>o;o++)i=hexVal(this.hash,s),e=fillOpacity(i),t=fillColor(i),r={fill:t,"fill-opacity":e,stroke:STROKE_COLOR,"stroke-opacity":STROKE_OPACITY},a=l%2===0?o%2===0?180:0:o%2!==0?180:0,this.svg.polyline(p,r).transform({translate:[o*n*.5-n/2,c*l],rotate:[a,n/2,c/2]}),0===o&&this.svg.polyline(p,r).transform({translate:[6*n*.5-n/2,c*l],rotate:[a,n/2,c/2]}),s+=1},Pattern.prototype.geoDiamonds=function(){var t,s,e,a,r,i,o,l,h=map(hexVal(this.hash,0),0,15,10,50),n=map(hexVal(this.hash,1),0,15,10,50),c=buildDiamondShape(h,n);for(this.svg.setWidth(6*h),this.svg.setHeight(3*n),e=0,l=0;6>l;l++)for(o=0;6>o;o++)i=hexVal(this.hash,e),a=fillOpacity(i),s=fillColor(i),r={fill:s,"fill-opacity":a,stroke:STROKE_COLOR,"stroke-opacity":STROKE_OPACITY},t=l%2===0?0:h/2,this.svg.polyline(c,r).transform({translate:[o*h-h/2+t,n/2*l-n/2]}),0===o&&this.svg.polyline(c,r).transform({translate:[6*h-h/2+t,n/2*l-n/2]}),0===l&&this.svg.polyline(c,r).transform({translate:[o*h-h/2+t,n/2*6-n/2]}),0===o&&0===l&&this.svg.polyline(c,r).transform({translate:[6*h-h/2+t,n/2*6-n/2]}),e+=1},Pattern.prototype.geoNestedSquares=function(){var t,s,e,a,r,i,o,l=map(hexVal(this.hash,0),0,15,4,12),h=7*l;for(this.svg.setWidth(6*(h+l)+6*l),this.svg.setHeight(6*(h+l)+6*l),s=0,o=0;6>o;o++)for(i=0;6>i;i++)r=hexVal(this.hash,s),e=fillOpacity(r),t=fillColor(r),a={fill:"none",stroke:t,opacity:e,"stroke-width":l+"px"},this.svg.rect(i*h+i*l*2+l/2,o*h+o*l*2+l/2,h,h,a),r=hexVal(this.hash,39-s),e=fillOpacity(r),t=fillColor(r),a={fill:"none",stroke:t,opacity:e,"stroke-width":l+"px"},this.svg.rect(i*h+i*l*2+l/2+2*l,o*h+o*l*2+l/2+2*l,3*l,3*l,a),s+=1},Pattern.prototype.geoMosaicSquares=function(){var t,s,e,a=map(hexVal(this.hash,0),0,15,15,50);for(this.svg.setWidth(8*a),this.svg.setHeight(8*a),t=0,e=0;4>e;e++)for(s=0;4>s;s++)s%2===0?e%2===0?drawOuterMosaicTile(this.svg,s*a*2,e*a*2,a,hexVal(this.hash,t)):drawInnerMosaicTile(this.svg,s*a*2,e*a*2,a,[hexVal(this.hash,t),hexVal(this.hash,t+1)]):e%2===0?drawInnerMosaicTile(this.svg,s*a*2,e*a*2,a,[hexVal(this.hash,t),hexVal(this.hash,t+1)]):drawOuterMosaicTile(this.svg,s*a*2,e*a*2,a,hexVal(this.hash,t)),t+=1},Pattern.prototype.geoPlaid=function(){var t,s,e,a,r,i,o,l=0,h=0;for(s=0;36>s;)a=hexVal(this.hash,s),l+=a+5,o=hexVal(this.hash,s+1),e=fillOpacity(o),t=fillColor(o),r=o+5,this.svg.rect(0,l,"100%",r,{opacity:e,fill:t}),l+=r,s+=2;for(s=0;36>s;)a=hexVal(this.hash,s),h+=a+5,o=hexVal(this.hash,s+1),e=fillOpacity(o),t=fillColor(o),i=o+5,this.svg.rect(h,0,i,"100%",{opacity:e,fill:t}),h+=i,s+=2;this.svg.setWidth(h),this.svg.setHeight(l)},Pattern.prototype.geoTessellation=function(){var t,s,e,a,r,i=map(hexVal(this.hash,0),0,15,5,40),o=i*Math.sqrt(3),l=2*i,h=i/2*Math.sqrt(3),n=buildRotatedTriangleShape(i,h),c=3*i+2*h,p=2*o+2*i;for(this.svg.setWidth(c),this.svg.setHeight(p),s=0;20>s;s++)switch(r=hexVal(this.hash,s),e=fillOpacity(r),t=fillColor(r),a={stroke:STROKE_COLOR,"stroke-opacity":STROKE_OPACITY,fill:t,"fill-opacity":e,"stroke-width":1},s){case 0:this.svg.rect(-i/2,-i/2,i,i,a),this.svg.rect(c-i/2,-i/2,i,i,a),this.svg.rect(-i/2,p-i/2,i,i,a),this.svg.rect(c-i/2,p-i/2,i,i,a);break;case 1:this.svg.rect(l/2+h,o/2,i,i,a);break;case 2:this.svg.rect(-i/2,p/2-i/2,i,i,a),this.svg.rect(c-i/2,p/2-i/2,i,i,a);break;case 3:this.svg.rect(l/2+h,1.5*o+i,i,i,a);break;case 4:this.svg.polyline(n,a).transform({translate:[i/2,-i/2],rotate:[0,i/2,h/2]}),this.svg.polyline(n,a).transform({translate:[i/2,p- -i/2],rotate:[0,i/2,h/2],scale:[1,-1]});break;case 5:this.svg.polyline(n,a).transform({translate:[c-i/2,-i/2],rotate:[0,i/2,h/2],scale:[-1,1]}),this.svg.polyline(n,a).transform({translate:[c-i/2,p+i/2],rotate:[0,i/2,h/2],scale:[-1,-1]});break;case 6:this.svg.polyline(n,a).transform({translate:[c/2+i/2,o/2]});break;case 7:this.svg.polyline(n,a).transform({translate:[c-c/2-i/2,o/2],scale:[-1,1]});break;case 8:this.svg.polyline(n,a).transform({translate:[c/2+i/2,p-o/2],scale:[1,-1]});break;case 9:this.svg.polyline(n,a).transform({translate:[c-c/2-i/2,p-o/2],scale:[-1,-1]});break;case 10:this.svg.polyline(n,a).transform({translate:[i/2,p/2-i/2]});break;case 11:this.svg.polyline(n,a).transform({translate:[c-i/2,p/2-i/2],scale:[-1,1]});break;case 12:this.svg.rect(0,0,i,i,a).transform({translate:[i/2,i/2],rotate:[-30,0,0]});break;case 13:this.svg.rect(0,0,i,i,a).transform({scale:[-1,1],translate:[-c+i/2,i/2],rotate:[-30,0,0]});break;case 14:this.svg.rect(0,0,i,i,a).transform({translate:[i/2,p/2-i/2-i],rotate:[30,0,i]});break;case 15:this.svg.rect(0,0,i,i,a).transform({scale:[-1,1],translate:[-c+i/2,p/2-i/2-i],rotate:[30,0,i]});break;case 16:this.svg.rect(0,0,i,i,a).transform({scale:[1,-1],translate:[i/2,-p+p/2-i/2-i],rotate:[30,0,i]});break;case 17:this.svg.rect(0,0,i,i,a).transform({scale:[-1,-1],translate:[-c+i/2,-p+p/2-i/2-i],rotate:[30,0,i]});break;case 18:this.svg.rect(0,0,i,i,a).transform({scale:[1,-1],translate:[i/2,-p+i/2],rotate:[-30,0,0]});break;case 19:this.svg.rect(0,0,i,i,a).transform({scale:[-1,-1],translate:[-c+i/2,-p+i/2],rotate:[-30,0,0]})}};